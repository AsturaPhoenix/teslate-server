<html>
  <head>
    <title>SimpleCast</title>
    <script type="text/javascript">
      var lastError;
      var log = "";
      
      window.onerror = function(message, url, lineNumber) {
        lastError = message + "\n" + url + ":" + lineNumber;
      };
      
      var isStopped = false;
      var lastReload = new Date();
      var lastProc = new Date();
      var lastFrameQuery = new Date();
      var lastFrame = new Date();
      var lastScreenQuery = new Date();
      var lastScreen = new Date();
      
      function debugInfo() {
        var debug = document.getElementById("debug");
        var status = document.getElementById("status");
        
        var staleness = lastProc.getTime() - lastFrame.getTime();
        if (staleness > 15000) {
          status.className = "status stale";
        } else if (staleness > 7500) {
          status.className = "status warning";
        } else {
          status.className = "status ok";
        }
        
        if (lastError) {
          debug.innerText = lastError;
        }
        if (log) {
          document.getElementById("log").innerText = log;
        }
      }

      function queue(f, freq) {
        if (!isStopped) {
          setTimeout(f, freq);
        }
      }

      function proclp() {
        lastProc = new Date();
        
        if (lastProc.getTime() - lastFrame.getTime() > 20000 &&
            lastProc.getTime() - lastReload.getTime() > 3000) {
          lastReload = lastProc;
          location.reload();
        }

        if (lastProc.getTime() - lastFrameQuery.getTime() > 7500) {
          frame();
        }

        if (lastProc.getTime() - lastScreenQuery.getTime() > 7500) {
          screen();
        }

        debugInfo();

        queue(proclp, 1000);
      }

      function frame() {
        lastFrameQuery = new Date();
        document.getElementById("frame").src =
          'https://simplecast-1297.appspot.com/frame/nautilus/frame.jpeg?v=' +
          lastFrameQuery.getTime();
      }

      function screen() {
        lastScreenQuery = new Date();
        var ph = new XMLHttpRequest();
        ph.open("HEAD", "https://simplecast-1297.appspot.com/frame/nautilus/previous.jpeg");
        ph.onreadystatechange = function() {
          if (ph.readyState == 4) {
            var newScreen = new Date(ph.getResponseHeader("Last-Modified"));
            if (newScreen.getTime() > lastScreen.getTime()) {
              document.getElementById("prev").src =
                'https://simplecast-1297.appspot.com/frame/nautilus/previous.jpeg?v=' +
                lastScreenQuery.getTime();
              lastScreen = newScreen;

            }
            queue(screen, 1000);
          }
        };
        ph.send();
      }

      function imgLoaded() {
        lastFrame = new Date();
        debugInfo();
        queue(frame, 0);
      }
      
      function send(msg) {
        var cmd = new XMLHttpRequest();
        cmd.open("POST", "https://simplecast-1297.appspot.com/command/nautilus")
        cmd.send(msg);
      }
      
      var lastClick;
      
      function sendMouse(event) {
        var img = document.getElementById("frame");
        var nx = event.offsetX / img.width,
            ny = event.offsetY / img.height;
        var args = [nx, ny].join(",");
        
        if (lastClick) {
          send(["MD", lastClick.args, args].join("|"));
          clearTimeout(lastClick.timeout);
          lastClick = null;
        } else {
          lastClick = {
            timeout: setTimeout(function() {
              send(["MC", args].join("|"));
              lastClick = null;
            }, 0),
            args: args};
        }
      }

      function toggle() {
        var bn = document.getElementById("togglebn");
        if (isStopped) {
          bn.src = "https://raw.githubusercontent.com/google/material-design-icons/master/av/1x_web/ic_stop_white_24dp.png";
          isStopped = false;
          proclp();
        } else {
          bn.src = "https://raw.githubusercontent.com/google/material-design-icons/master/av/1x_web/ic_play_arrow_white_24dp.png";
          isStopped = true;
        }
      }
      
      function debug(msg) {
        log = msg;
      }
    </script>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <div class="controls">
      <div id="debug">
      </div>
      <table class="buttons">
        <tr>
          <td colspan="6" onclick="toggle()">
	    <div id="status" class="status">
              <img id="togglebn" src="https://raw.githubusercontent.com/google/material-design-icons/master/av/1x_web/ic_stop_white_24dp.png">
	    </div>
          </td>
        <tr>
          <td colspan="3" onclick="send('ZI')">
            <img src="https://raw.githubusercontent.com/google/material-design-icons/master/action/1x_web/ic_zoom_in_white_24dp.png">
          </td>
          <td colspan="3" onclick="send('ZO')">
            <img src="https://raw.githubusercontent.com/google/material-design-icons/master/action/1x_web/ic_zoom_out_white_24dp.png">
          </td>
        <tr>
          <td colspan="2" onclick="send('R')">
            <img src="https://raw.githubusercontent.com/google/material-design-icons/master/action/1x_web/ic_launch_white_24dp.png">
          </td>
          <td class="home" colspan="2" onclick="send('H')">
            <img src="https://raw.githubusercontent.com/google/material-design-icons/master/action/1x_web/ic_home_white_24dp.png">
          </td>
          <td class="back" colspan="2" onclick="send('B')">
            <img src="https://raw.githubusercontent.com/google/material-design-icons/master/navigation/1x_web/ic_arrow_back_white_24dp.png">
          </td>
      </table>
      <div id="log">
      </div>
    </div>
    <img class="canvas" id="frame" src="https://simplecast-1297.appspot.com/frame/nautilus/frame.jpeg"
         draggable="false"
         onload="imgLoaded()"
         onclick="sendMouse(event)"
         onmousedown="debug('md')"
         onmousemove="debug('mm')"
         ondrag="debug('d')"
         onscroll="debug('s')"
         ontouchstart="debug('ts')"
         ontouchmove="debug('t')">
    <img class="canvas" id="prev" src="https://simplecast-1297.appspot.com/frame/nautilus/previous.jpeg">
    <script type="text/javascript">
      proclp();
    </script>
  </body>
</html>
